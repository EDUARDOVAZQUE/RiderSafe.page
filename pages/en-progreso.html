<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>En Progreso - RiderSafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/global.css">

    <!-- IMPORTANTE: Librer√≠a de EmailJS necesaria para contact.js -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>

<body>

    <div class="container mt-5">
        <div id="status-message" class="text-center p-5 border rounded shadow-sm bg-white">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h2>Procesando la Compra...</h2>
            <p class="lead">Simulando la confirmaci√≥n de pago por parte del vendedor.</p>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTACIONES
        import { registerNewLicense, checkAuthStatus, getUserData } from "../assets/js/modules/auth.js";
        import { sendLicenseEmail } from "../assets/js/modules/contact.js";

        window.onload = async function () {
            const statusElement = document.getElementById('status-message');

            // 2. VERIFICACI√ìN DE SESI√ìN Y DATOS
            const user = await checkAuthStatus();
            const purchaseDataString = localStorage.getItem('simulated_purchase_data');

            if (!user) {
                statusElement.innerHTML = `<h2 class="text-danger">‚ùå No has iniciado sesi√≥n</h2><p>Redirigiendo...</p>`;
                setTimeout(() => window.location.href = "../index.html", 3000);
                return;
            }

            if (!purchaseDataString) {
                statusElement.innerHTML = `<h2 class="text-warning">‚ö†Ô∏è No hay compra activa</h2><p>Volviendo al inicio...</p>`;
                setTimeout(() => window.location.href = "../index.html", 3000);
                return;
            }

            const purchaseData = JSON.parse(purchaseDataString);

            // 3. SIMULACI√ìN DE ESPERA (UX)
            await new Promise(resolve => setTimeout(resolve, 2500));

            statusElement.innerHTML = `
            <div class="spinner-grow text-success mb-3" role="status"></div>
            <h2>‚úÖ Pago Confirmado.</h2>
            <p>Generando tu licencia √∫nica en la nube...</p>
        `;

            try {
                // 4. GENERAR Y REGISTRAR EL C√ìDIGO (Transacci√≥n At√≥mica)
                // Se usa substring en UID para simular un ID de transacci√≥n m√°s corto
                const result = await registerNewLicense(
                    `SIM-${purchaseData.purchaseTime}-${user.uid.substring(0, 5)}`,
                    user.uid,
                    purchaseData.plan
                );

                if (result.success) {
                    // 5. ENV√çO DE CORREO ELECTR√ìNICO
                    statusElement.innerHTML += `<p class="text-info mt-2">üìß Enviando confirmaci√≥n a tu correo...</p>`;

                    // Obtenemos nombre y correo real desde Firestore
                    const userData = await getUserData(user.uid);
                    const userName = userData?.fullName || "Usuario";
                    const userEmail = userData?.email || user.email;

                    // Llamada al servicio de email (no bloquea la UI si falla)
                    await sendLicenseEmail(userEmail, userName, result.code, purchaseData.plan);

                    // 6. MOSTRAR √âXITO FINAL
                    statusElement.innerHTML = `
                    <div class="text-success mb-4">
                        <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                    </div>
                    <h2 class="mb-3">üéâ ¬°Licencia Generada!</h2>
                    <p>Hemos enviado los detalles a <strong>${userEmail}</strong>.</p>
                    
                    <div class="alert alert-secondary d-inline-block px-5 py-3 mt-2">
                        <p class="mb-0 fs-5 text-muted">Tu c√≥digo es:</p>
                        <strong class="fs-2 user-select-all text-dark" style="letter-spacing: 2px;">${result.code}</strong>
                    </div>
                    
                    <p class="mt-3 text-muted">Copia este c√≥digo para activar tu dispositivo.</p>
                    <a href="../dashboard/dashboard.html" class="btn btn-primary btn-lg mt-3">Ir al Dashboard</a>
                `;

                    // Limpiar storage para evitar re-generaci√≥n al recargar
                    localStorage.removeItem('simulated_purchase_data');

                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error(error);
                statusElement.innerHTML = `
                <h2 class="text-danger">‚ùå Error en el Sistema</h2>
                <p>Ocurri√≥ un error al registrar tu licencia. Por favor contacta a soporte.</p>
                <code class="text-danger d-block mt-2">${error.message || "Error desconocido"}</code>
                <a href="../index.html" class="btn btn-outline-secondary mt-3">Volver al Inicio</a>
            `;
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>